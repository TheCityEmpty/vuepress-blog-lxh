<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入了解 JavaScript 模块化 | 江湖录</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="日常工作中我们经常使用 export 导出，import 导入， 又或者是 module.exports 导出， require 导入。但是我们却不了解他们，让我们从历史到现在的发展深入了解 JavaScript 模块化。">
    
    <link rel="preload" href="/vuepress-blog-lxh/assets/css/0.styles.253d253c.css" as="style"><link rel="preload" href="/vuepress-blog-lxh/assets/js/app.8d32188a.js" as="script"><link rel="preload" href="/vuepress-blog-lxh/assets/js/2.ae6c3983.js" as="script"><link rel="preload" href="/vuepress-blog-lxh/assets/js/20.f70dd27d.js" as="script"><link rel="preload" href="/vuepress-blog-lxh/assets/js/6.b516d596.js" as="script"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/10.362c3091.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/11.d9f79592.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/12.8d36d4e0.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/13.7663dd42.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/14.616766c6.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/15.a80cddf5.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/16.8d635d16.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/17.0e2f7697.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/18.ad92e712.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/19.9a616bcd.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/21.ead17315.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/22.4adc24b8.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/23.741273c3.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/24.960c4de1.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/25.71255207.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/26.99bdf89d.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/27.a7cfdd9f.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/28.73ce90d6.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/29.86001c69.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/3.0d3a7d18.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/30.f7879cbd.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/31.378c1464.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/32.7569ba20.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/33.d86bcecd.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/34.f8189bcb.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/35.ca59a7c5.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/4.1c645c93.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/5.d5f27362.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/7.26863545.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/8.35a881dd.js"><link rel="prefetch" href="/vuepress-blog-lxh/assets/js/9.fd4b449d.js">
    <link rel="stylesheet" href="/vuepress-blog-lxh/assets/css/0.styles.253d253c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog-lxh/" class="home-link router-link-active"><img src="/vuepress-blog-lxh/logo.svg" alt="江湖录" class="logo"> <span class="site-name can-hide">江湖录</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-blog-lxh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/vuepress-blog-lxh/other-pages/category.html" class="nav-link">
  文章分类
</a></div> <a href="https://github.com/TheCityEmpty/vuepress-blog-lxh/tree/code" target="_blank" rel="noopener noreferrer" class="repo-link">
    github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress-blog-lxh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/vuepress-blog-lxh/other-pages/category.html" class="nav-link">
  文章分类
</a></div> <a href="https://github.com/TheCityEmpty/vuepress-blog-lxh/tree/code" target="_blank" rel="noopener noreferrer" class="repo-link">
    github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>深入了解 JavaScript 模块化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog-lxh/javascript/js-module.html#javascript-模块化-的历史" class="sidebar-link">JavaScript 模块化 的历史</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-blog-lxh/javascript/js-module.html#_1-script-标签-和-闭包" class="sidebar-link">1. Script 标签 和 闭包</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog-lxh/javascript/js-module.html#_2-amd规范-requirejs-angularjs" class="sidebar-link">2. AMD规范 -&gt; RequireJS, AngularJS</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog-lxh/javascript/js-module.html#_3-commonjs-规范" class="sidebar-link">3. CommonJS 规范</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog-lxh/javascript/js-module.html#_4-ecmascript-modules-esm" class="sidebar-link">4. ECMAScript Modules(ESM)</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog-lxh/javascript/js-module.html#_5-在浏览器中运行-esm" class="sidebar-link">5. 在浏览器中运行 ESM</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog-lxh/javascript/js-module.html#_6-esm-和-commonjs-模块的差异" class="sidebar-link">6. ESM 和 CommonJS 模块的差异</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog-lxh/javascript/js-module.html#_7-如何在-node-中运行-es6-模块" class="sidebar-link">7. 如何在 Node 中运行 ES6 模块</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog-lxh/javascript/js-module.html#_8-commonjs-模块加载-es6-模块" class="sidebar-link">8. CommonJS 模块加载 ES6 模块</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog-lxh/javascript/js-module.html#_9-es6-模块-加载-commonjs-模块" class="sidebar-link">9.  ES6 模块 加载 CommonJS 模块</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="深入了解-javascript-模块化"><a href="#深入了解-javascript-模块化" class="header-anchor">#</a> 深入了解 JavaScript 模块化</h1> <h2 id="javascript-模块化-的历史"><a href="#javascript-模块化-的历史" class="header-anchor">#</a> JavaScript 模块化 的历史</h2> <p>想要真正的了解一样东西，就得从源头开始研究。我们将通过了解 <code>JavaScript</code>模块化 的发展史来学习<code>JavaScript</code>模块化。</p> <h3 id="_1-script-标签-和-闭包"><a href="#_1-script-标签-和-闭包" class="header-anchor">#</a> 1. Script 标签 和 闭包</h3> <p>HTML 网页中， 浏览器通过 <code>&lt;script&gt;&lt;/script&gt;</code> 标签加载 JavaScript 脚本。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 页面内嵌的脚本 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>application/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// module code</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 外部脚本 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>application/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./myModule.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>上面代码中，由于浏览器脚本的默认语言是 JavaScript，因此 <code>type=&quot;application/javascript&quot;</code> 可以省略。</p> <p>默认情况下，浏览器将从上往下执行代码。在执行时遇到了 <code>&lt;script&gt;&lt;/script&gt;</code> 标签将会停下来去执行 script 脚本。</p> <p>如果脚本很大，将造成页面卡住。这显然是不好的，所以浏览器允许这些脚本异步去加载。</p> <p>我们下面去做一个实验， 来了解 <code>defer</code> 和 <code>async</code> 的加载顺序。</p> <p>下面代码中，<code>script</code> 标签打开 <code>defer</code> 或者 <code>async</code> 属性，脚本就会异步加载。浏览器的渲染引擎遇到这一行代码，就会开始下载外部脚本，但不会等它下载和执行，而是直接执行后面的命令。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">defer</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./export.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- export.js 里只有一行输出语句： console.log('export')  --&gt;</span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">async</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>./import.js<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- import.js 里只有一行输出语句： console.log('import')  --&gt;</span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

  ...下面大约5000个div
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>asdasdasd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>输出的结果如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>
<span class="token number">4</span>
<span class="token function">import</span>
<span class="token builtin class-name">export</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>由此我们可以得出结论，<code>defer</code> 和 <code>async</code> 的区别是：</p> <p><code>defer</code> 要等到整个页面正常渲染结束（DOM 结构完全生成，以及其他脚本执行完成），才会执行。</p> <p><code>async</code> 一但将脚本下载完成，浏览器渲染引擎就会中断渲染，执行这个脚本，执行完成后再继续渲染剩下的 DOM。</p> <p>如果有多个 <code>defer</code> 脚本，会按照它们出现在页面的顺序 加载。而又多个 <code>async</code> 是不能保证加载顺序的。</p> <p>通过 <code>script</code> 方式加载的脚本都共享一个全局作用域 <code>window</code> ，在其中定义的变量都将挂载在 <code>window</code> 这个全局变量中。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">defer</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./export.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">async</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>./import.js<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// export.js</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>
<span class="token comment">/*
  {
    a: 1,
    ...,
    b: 2,
    ...
  }
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>而随着 Web 应用越来越复杂，这种共享全局作用域的方式弊端开始显现出来。于是 <code>IIFE</code> (立即调用函数表达式) 就被发明出来了。</p> <p><code>IIFE</code> 就是一整段代码包裹在一个函数中，然后立即执行该函数。</p> <p>我们都知道在每个函数都有着自己的作用域，而我们使用 <code>IIFE</code> 就形成了一个个单独的作用域，在其中定义的变量将无法污染外面的变量。</p> <p>下面有几种 <code>IIFE</code> 的写法，第一种是最常见的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// code todo</span>
 <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">~</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// code todo</span>
 <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">void</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// code todo</span>
  <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在其中定义的变量 <code>a</code>， <code>b</code>，<code>c</code> 将不会挂载在 <code>window</code> 上。</p> <h3 id="_2-amd规范-requirejs-angularjs"><a href="#_2-amd规范-requirejs-angularjs" class="header-anchor">#</a> 2. AMD规范 -&gt; RequireJS, AngularJS</h3> <p><code>RequireJS</code> 和  <code>AngularJS</code> 的出现让前端终于有了一点模块化的雏形。</p> <p>下面的方法就是 <code>RequireJS</code> 的核心，他接受两个参数， 第一个是数组，表示所需要加载的模块，第二个是回调函数，当数组里的模块都被加载完之后就会执行和这个回调函数。加载的模块会以参数的形势传入该函数，从而在该函数内部使用这些模块。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'moduleA'</span><span class="token punctuation">,</span> <span class="token string">'moduleB'</span><span class="token punctuation">,</span> <span class="token string">'moduleC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">moduleA<span class="token punctuation">,</span> moduleB<span class="token punctuation">,</span> moduleC</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
　　　<span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>使用过 <code>RequireJS</code> 和 <code>AngularJS</code> 的同学都发现了一个问题， API 不够直观，使用起来不是很方便。</p> <h3 id="_3-commonjs-规范"><a href="#_3-commonjs-规范" class="header-anchor">#</a> 3. CommonJS 规范</h3> <p>再之后， Node.js 横空出世。并带来了属于他的模块化方案 <code>CommonJS</code>，简称 <code>CJS</code>。</p> <p>在 Node.js 中可以访问文件，每一个文件都是一个单独的作用域。</p> <p>我们可以通过 <code>require</code> 方法来加载别的文件，通过 <code>module.exports</code> 方式来将文件中的内容输出出去。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./m.js'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// m.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  count<span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>CommonJS</code> 模块的特点如下：</p> <ol><li><p><strong>所有代码都在模块作用域运行，不会污染全局作用域。</strong></p></li> <li><p><strong>模块可以加载多次，但是只会在第一次加载时运行一次，然后运行结果就被缓存了，之后再加载，就直接读取缓存结果。想要让模块再次运行，必须清楚缓存。</strong></p></li> <li><p><strong>模块加载的顺序，按照其在代码中出现的顺序。</strong></p></li></ol> <p><code>CommonJS</code> 规范规定，每个模块内容， <code>module</code> 变量代表当前模块。这个变量是一个对象，它的 <code>exports</code> 属性（即 <code>module.exports</code>）是对外的接口。加载或者导入某个模块就是加载这个模块的 <code>module.exports</code> 属性。</p> <p>下面是打印整个 <code>module</code> 对象：可以看到这个模块我们向外导出了一个 <code>count</code> 变量。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Module <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token comment">// 模块的识别符，通常是带有绝对路径的模块文件名</span>
  path<span class="token operator">:</span> <span class="token string">'e:\\lxh-code\\study-exm\\js模块化'</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 表示模块对外输出的值</span>
  parent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 一个对象，表示调用该模块的模块</span>
  filename<span class="token operator">:</span> <span class="token string">'e:\\lxh-code\\study-exm\\js模块化\\export.js'</span><span class="token punctuation">,</span> <span class="token comment">// 模块文件名，带有绝对路径</span>
  loaded<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 一个布尔值，表示模块是否已经完成加载</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 一个数组，表示该模块要用到的其他模块</span>
    Module <span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token string">'e:\\lxh-code\\study-exm\\js模块化\\import.js'</span><span class="token punctuation">,</span>
      path<span class="token operator">:</span> <span class="token string">'e:\\lxh-code\\study-exm\\js模块化'</span><span class="token punctuation">,</span>
      exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      parent<span class="token operator">:</span> <span class="token punctuation">[</span>Circular <span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> <span class="token string">'e:\\lxh-code\\study-exm\\js模块化\\import.js'</span><span class="token punctuation">,</span>
      loaded<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      paths<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  paths<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'e:\\lxh-code\\study-exm\\js模块化\\node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'e:\\lxh-code\\study-exm\\node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'e:\\lxh-code\\node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'e:\\node_modules'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>为了方便， <code>nodeJS</code> 还提供了一个 <code>exports</code> 变量指向 <code>module.exports</code>。这等同于在模块头部，有一行这样的命令。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面两种写法的结果完全一致：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 写法 一</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 写法 二</span>

exports<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但是有一个问题，使用 <code>exports</code> 的写法时，只能往上面添加属性而不能重新赋值，这很容易理解， 当你赋值的时候，你就切断了和 <code>module.exports</code> 的联系了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 这是正确的</span>
exports<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment">// 这是错误的</span>
<span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span>
exports <span class="token operator">=</span> count
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>所以有时候确实很难区分 <code>module.exports</code> 和 <code>exports</code> 的区别， 那只用一个好了。</p> <h3 id="_4-ecmascript-modules-esm"><a href="#_4-ecmascript-modules-esm" class="header-anchor">#</a> 4. ECMAScript Modules(ESM)</h3> <p>基于之前的遗憾，<code>javascript</code> 在 <code>es6</code> 中终于推出了 属于自己的模块化，简称 <code>ESM</code>。</p> <p>相比于 <code>CommonJS</code> 的运行时加载，<code>es6</code> 模块的设计思想是尽量的静态化，使得编译时就能确定模块的依赖关系，以及输入和输出的变量。</p> <p>ES6 的模块自动采用严格模式，不管你有没有在模块头部加上 <code>&quot;use strict&quot;</code>。</p> <p>严格模式主要有以下限制。</p> <p><strong>下面代码在 非严格模式 下皆不会报错！</strong></p> <p><strong>下面代码皆假如处于 严格模式 下，注释即在严格模式下的报错信息！</strong></p> <ol><li>变量必须声明后再使用</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">// 报错：ReferenceError: a is not defined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>函数的参数不能有同名属性，否则报错</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fn</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// SyntaxError: Duplicate parameter name not allowed in this context</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="3"><li>不能使用with语句</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token punctuation">{</span>
    b<span class="token operator">:</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'aa'</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">14</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">with</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// SyntaxError: Strict mode code may not include a with statement</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="4"><li><p>不能对只读属性赋值，否则报错</p></li> <li><p>不能使用前缀 0 表示八进制数，否则报错</p></li> <li><p>不能删除不可删除的属性，否则报错</p></li> <li><p>不能删除变量delete prop，会报错，只能删除属性delete global[prop]</p></li> <li><p>eval不会在它的外层作用域引入变量</p></li> <li><p>eval和arguments不能被重新赋值</p></li> <li><p>arguments不会自动反映函数参数的变化</p></li> <li><p>不能使用arguments.callee</p></li> <li><p>不能使用arguments.caller</p></li> <li><p>禁止this指向全局对象</p></li> <li><p>不能使用fn.caller和fn.arguments获取函数调用的堆栈</p></li> <li><p>增加了保留字（比如protected、static和interface）</p></li></ol> <p><code>ESM</code> 主要由两个命令构成： <code>export</code> 和 <code>import</code> 命令。</p> <p><strong><code>export</code> 用于对外输出， <code>import</code> 用于对内输入。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// export.js</span>

<span class="token keyword">export</span> <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
<span class="token comment">// 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>需要注意的一点， <code>export</code> 命令规定对外的接口， 必须与模块内部的变量建立一一对应的关系。</p> <p><strong>两种导出的写法：</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 写法一：</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">// 写法二：</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  count
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>其他的写法都没有与 <code>export</code> 建立联系， 将无法生效。</p> <p>比如像下面的写法是错误的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">export</span> count
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>还要一个很重要的， <strong><code>export</code> 输出的接口和模块中的变量是动态绑定的，即通过该接口可以取到模块内部的最新值（或者说实时值）。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// export.js</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">1</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> count<span class="token operator">++</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>

<span class="token comment">// 1</span>

<span class="token comment">// 延迟500ms 后，输出了 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>export</code> 命令和 <code>import</code> 命令可以出现在模块任何位置，只要出现在顶层就可以了。如果处于块级作用域中，就会报错。这是因为处于条件代码块之内，就没法
进行静态优化了，违背了 ES6 的设计初衷。</p> <p>下面的代码就会报错了：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  <span class="token keyword">export</span> <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>

<span class="token comment">// SyntaxError: Unexpected token 'export'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当我们模块中有重复的名字该怎么办？</p> <p>我们可以使用 <code>as</code> 关键字来重命名。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// export.js</span>
<span class="token keyword">let</span> api <span class="token operator">=</span> <span class="token string">'http://www.baidu.com'</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
  api <span class="token keyword">as</span> $__API
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> $__API <span class="token keyword">as</span> api <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span>
<span class="token comment">// http://www.baidu.com</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>由上面的所有示例代码我们可以看出， <code>export</code> 对外输出的变量名和 <code>import</code> 对内输入的变量名必须相同，否则将取不到值。当然你也可以使用 <code>as</code> 关键字来重命名。</p> <p>为了避免整个输入输出的流向正常， <code>ESM</code> 规定 <code>import</code> 对内输入的变量是只读的， 无法去修改。如下就会报错！</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>
<span class="token comment">// import.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> $__API <span class="token keyword">as</span> api <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

api <span class="token operator">=</span> <span class="token string">''</span>
<span class="token comment">// TypeError: Assignment to constant variable.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>但是如果 <code>api</code> 是个对象， 你去修改对象的属性是可以的。但是这种写法是很难排错的，不建议这样写。</strong></p> <p>每当你 <code>import</code> 一个文件进来时， 你就相当于运行了该文件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// export.js</span>

consolel<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'运行 export.js'</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'运行了 import.js'</span><span class="token punctuation">)</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>运行 <code>import.js</code> ， 结果如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>运行 export.js
运行了 import.js
<span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>从这个示例我们可以发现几个结论：</p> <ol><li><p>每当你 <code>import</code> 一个文件进来时， 你就相当于运行了该文件</p></li> <li><p><code>import</code> 命令具有提升效果，会自动提升到模块顶部。导致首先会去运行 导入的模块。所以 <code>运行 export.js</code> 第一个输出。</p></li></ol> <p>如果你只是想执行（运行）你导入的模块， 那你可以这样，它仅仅执行 <code>export.js</code> ，不输出任何值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'export.js'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果重复执行同一个模块，将只执行一次：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// export.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'运行 export.js'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>
<span class="token keyword">import</span> <span class="token string">'./export.js'</span>
<span class="token keyword">import</span> <span class="token string">'./export.js'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>运行结果如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>运行 export.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>由于 <code>import</code> 是静态执行，所以不能使用表达式和变量，这些只有在运行时才能得到结果的语法解构是不能使用的。</strong></p> <p>如下面的语法都是错误的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'exe'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$__</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./name.js'</span>

<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">'./../name.js'</span>
<span class="token keyword">import</span> url

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span> <span class="token string">'./a.js'</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span> <span class="token string">'./b.js'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>除了指定加载某个输出值外，我们还可以使用 <code>*</code> 关键字来输出全部。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> all <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>当你采用 <code>*</code> 来输出全部的时候，你无法修改 <code>all</code> ，包括属性也无法修改。</p> <p>下面的代码会报错。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> all <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

all<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Luoxuehi'</span>
<span class="token comment">// 报错 TypeError: Cannot assign to read only property 'name' of object '[object Module]'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在 <code>ESM</code> 中， 还有一个默认输出 <code>export default</code> ，每个模块只能有一个默认输出。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// export.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'xxx'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">28</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> sex <span class="token operator">=</span> <span class="token string">'男'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">,</span>
  age<span class="token punctuation">,</span>
  sex
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> all <span class="token keyword">from</span> <span class="token string">'./export.js'</span>
<span class="token keyword">import</span> info <span class="token keyword">from</span> <span class="token string">'./export.js'</span>
<span class="token keyword">import</span> info1<span class="token punctuation">,</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
<span class="token comment">// { name: 'xxx', age: 28, sex: '男' }</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span>
<span class="token comment">//  {</span>
<span class="token comment">//   age: 28,</span>
<span class="token comment">//   default: { name: 'xxx, age: 28, sex: '男' },</span>
<span class="token comment">//   name: 'xxx',</span>
<span class="token comment">//   sex: '男'</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>从上面代码中我们可以得到几个结论：</p> <ol><li><p>默认输出 和 普通输出时可以写在一起的</p></li> <li><p>默认输入 和 不同输入也可以写在一起: <code>import info1, { name } from './export.js'</code></p></li> <li><p>默认输出每个模块只有一个</p></li> <li><p>默认输出其实是 将 <code>default</code> 作为键值来输出内容的</p></li> <li><p>默认输出的时候其实是输出匿名变量的， 即你在 <code>import</code> 时可以任意命名</p></li> <li><p>当你直接 <code>import info from './export.js'</code> 不使用大括号的时候，他输入的就是 默认输出。</p></li></ol> <p>本质上，<code>export default</code> 就是输出一个叫做 <code>default</code> 的变量或方法，然后系统允许你为它任意取名。</p> <p>所以下面两个写法是一致的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'xxx'</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  name <span class="token keyword">as</span> <span class="token keyword">default</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'xxx'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>从上面结论的第二条， <strong>默认输出每个模块只有一个</strong>，下面的写法是不允许的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'xxx'</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
  name <span class="token keyword">as</span> <span class="token keyword">default</span>
<span class="token punctuation">}</span>

<span class="token comment">// 报错， 只能有一个 默认输出</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'cc'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>除了输出， 输入我们也可以这样理解， 所以下面两行也是一致的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import name from './export.js'</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果我们需要同时写上的话， 请修改下变量名即可，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> name1 <span class="token keyword">from</span> <span class="token string">'./export.js'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name1<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当我们把 <code>export</code> 和 <code>import</code> 写在一个模块时，这时表示的是 将 <code>export.js</code> 中的 <code>name</code> 和 <code>age</code> 转发出去：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

<span class="token comment">// 与下面相等</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>再看下面的代码。这时需要注意，当 <code>export</code> 和 <code>import</code> 写在一行时， <code>name</code> 和 <code>age</code> 并没有被引入当前模块，只是相对于对外转发这两个接口，导致了当前模块不能直接使用 <code>name</code> 和 <code>age</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

<span class="token comment">// 报错 ReferenceError: name is not defined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>下面看一些其他写法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 接口改名</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> name <span class="token keyword">as</span> username<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

<span class="token comment">// 整体输出</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

<span class="token comment">// 将 export.js 的默认接口 指定为 当前模块的默认接口 输出</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

<span class="token comment">// 将 export.js 的 name 变量作为 当前模块的默认接口输出</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> name <span class="token keyword">as</span> <span class="token keyword">default</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

<span class="token comment">// 将 export.js 的默认接口作为 当前模块的 info 变量进行输出</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> info <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>基于上面的一些知识，那模块与模块之前的继承我们可以这样写：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// parent.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// chilren.js</span>

<span class="token comment">// 我们将继承 parent.js 中的所有字段</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./parent.js'</span>

<span class="token comment">// 开始新添 属于 chilren.js 的独有属性</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>前面介绍过， <code>import</code> 命令只能在模块顶层，无法在代码块中， 也无法使用表达式来书写。因为 <code>import</code> 命令会被 JS 引擎静态分析，先于模块内的其他语句执行。</p> <p>这样设计虽然有利于编译器提高效率。但也导致无法在运行时加载模块。在语法上，条件加载就不可能实现。如果 <code>import</code> 命令要取代Node中 <code>require</code> 方法，这就无法进行取代了。因为 <code>require</code> 方法是运行时加载模块，<code>import</code> 命令无法取代 <code>require</code> 方法中的动态加载模块。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'white'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'white-style.css'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'block-style.css'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上面就是动态加载，到底加载哪个模块， 需要在运行时才能决定的。而 <code>import</code> 命令做不到这一点。</p> <p><a href="https://github.com/tc39/proposal-dynamic-import" target="_blank" rel="noopener noreferrer">ES2020提案<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 引入 <code>import()</code> 方法，支持动态加载。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 语法</span>
<span class="token keyword">import</span><span class="token punctuation">(</span>模块路径<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>import</code> 命令能支持什么参数， <code>import()</code> 方法就能支持什么参数。唯一的区别就是 <code>import()</code> 方法能动态加载。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./export.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// {</span>
<span class="token comment">//   age: 28,</span>
<span class="token comment">//   default: { name: 'xxx', age: 28, sex: '男' },</span>
<span class="token comment">//   name: 'xxx',</span>
<span class="token comment">//   sex: '男'</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>import()</code> 方法返回一个 <code>Promise</code> 对象，所以 <code>import()</code> 方法是异步加载的。而 Node中的 <code>require</code> 方法是同步的。</p> <h3 id="_5-在浏览器中运行-esm"><a href="#_5-在浏览器中运行-esm" class="header-anchor">#</a> 5. 在浏览器中运行 ESM</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;./export.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> src<span class="token operator">=</span><span class="token string">'./import.js'</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们将 <code>&lt;script&gt;&lt;/script&gt;</code> 标签的 type 属性设置为 <code>module</code> 即可在在浏览器中运行 ES6 模块了，这时候我们告知了浏览器这个文件是个 ES6 模块。</p> <p>浏览器对带有 <code>type=&quot;module&quot;</code> 的 <code>&lt;script&gt;&lt;/script&gt;</code>，都是异步加载，不会造成堵塞浏览器，而是等到整个页面渲染完成后再去执行脚本。等同于打开了 <code>&lt;script&gt;&lt;/script&gt;</code> 的 <code>defer</code> 属性。如果浏览器有多个 <code>type=&quot;module&quot;</code> 的 <code>&lt;script&gt;&lt;/script&gt;</code> ，他们会按照在页面中出现的顺序依次执行。</p> <p>对于这种加载一个文件的 <code>type=&quot;module&quot;</code> ，我们需要启动一个服务来运行整个 <code>html</code>，否则会出现跨域问题。</p> <p>建议在 <code>VS code</code> 中安装一个 <code>Live Server</code> 即可轻易实验下模块化。</p> <h3 id="_6-esm-和-commonjs-模块的差异"><a href="#_6-esm-和-commonjs-模块的差异" class="header-anchor">#</a> 6. ESM 和 CommonJS 模块的差异</h3> <p>在了解如何在 <code>Node</code> 中运行 ES6 模块前，我们需要了解下 ESM 和 CommonJS 模块的差异。</p> <p>ESM 和 CommonJS 模块主要有三个差异：</p> <ul><li><ol><li>CommonJS 模块输出的是一个值的拷贝， ES6 模块输出的是一个值的引用。</li></ol></li> <li><ol start="2"><li>CommonJS 模块是运行时加载，  ES6 模块是编译时输出接口</li></ol></li> <li><ol start="3"><li>CommonJS 模块的 <code>require()</code> 方法是同步加载模块，而ES6 模块的 <code>import</code> 命令是异步加载，它有一个独立的模块依赖解析阶段。</li></ol></li></ul> <p>下面的代码就能充分体现第一个差异：</p> <p>可以看到 CommonJS 模块 输出的是值的拷贝，也就是说一旦输出了一个值，模块内部的变化就影响不到这个值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// CommonJS 模块</span>

<span class="token comment">// 输出</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  count
<span class="token punctuation">}</span>

<span class="token comment">// 输入</span>
<span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./export.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
<span class="token comment">// 0</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
  <span class="token comment">// 0</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>而在 ES6 模块 中却是不一样的， ES6 模块输出的是值的引用， 内部值的变化是可以影响到外部的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// export.js</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">1</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> count<span class="token operator">++</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>

<span class="token comment">// 1</span>

<span class="token comment">// 延迟500ms 后，输出了 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_7-如何在-node-中运行-es6-模块"><a href="#_7-如何在-node-中运行-es6-模块" class="header-anchor">#</a> 7. 如何在 <code>Node</code> 中运行 ES6 模块</h3> <p>CommonJS 是独属于 Node.js 的，和 ES6 模块并不兼容。语法上面，两者最明显的差异是：CommonJS 模块使用 <code>require()</code> 和 <code>module.exports</code> ，ES6 模块使用 <code>import</code> 和 <code>export</code> 。</p> <p>从 Node.js v13.2 版本开始，Node.js 默认打开了对 ES6 模块的支持。</p> <p>如果你要在 Node.js 中使用 ES6 模块， 有两种方法：</p> <ol><li><p>将文件名从 <code>.js</code> 后缀 改为 <code>.mjs</code>，这样 Node.js 就会对这个模块采用 ES6 模块方式进行解析。并且默认打开严格模式。</p></li> <li><p>如果不希望改后缀，那就在项目中的 <code>package.json</code> 文件中，将 <code>type</code> 字段指定为 <code>module</code>。实例如下：</p></li></ol> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
   <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果你要在 Node.js 中使用 本来的 CommonJS 模块， 也有两种方法，和上面的方法正好相反：</p> <ol><li><p>将文件名从 <code>.js</code> 后缀 改为 <code>.cjs</code>，这样 Node.js 就会对这个模块采用  CommonJS 模块方式进行解析。</p></li> <li><p>如果不希望改后缀，那就在项目中的 <code>package.json</code> 文件中，将 <code>type</code> 字段指定为 <code>commonjs</code>。实例如下：</p></li></ol> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
   <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;commonjs&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>需要注意的是，两种方式不要混着用， <code>.mjs</code> 后缀的只能识别 ES6 模块，<code>.cjs</code> 后缀的只能识别CommonJS 模块。</p> <h3 id="_8-commonjs-模块加载-es6-模块"><a href="#_8-commonjs-模块加载-es6-模块" class="header-anchor">#</a> 8. CommonJS 模块加载 ES6 模块</h3> <p>有时候我们写 Node.js 程序的时候采用了默认的 CommonJS 模块来处理模块化。然后我们需要引入一个 采用ES6 模块 的 库。</p> <p>CommonJS 模块的 <code>require()</code> 命令不能加载 ES6 模块，会报错。但是我们可以使用 <code>import()</code> 这个方法来加载。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// export.mjs</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'xxx'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">28</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> sex <span class="token operator">=</span> <span class="token string">'男'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">,</span>
  age<span class="token punctuation">,</span>
  sex
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./export.mjs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_9-es6-模块-加载-commonjs-模块"><a href="#_9-es6-模块-加载-commonjs-模块" class="header-anchor">#</a> 9.  ES6 模块 加载 CommonJS 模块</h3> <p>有时候我们写 Node.js 程序的时候采用了ES6 模块来处理模块化。然后我们需要引入一个 采用 CommonJS 模块 的 库。</p> <p>ES6 模块 的 <code>import</code> 命令 可以加载 CommonJS 模块， 但是只能整体加载。不能进行解构加载。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// export.cjs</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'xxx'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>

<span class="token keyword">import</span> info <span class="token keyword">from</span> <span class="token string">'./export.cjs'</span>
<span class="token comment">// 成功</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./export.cjs'</span>
<span class="token comment">// 报错 SyntaxError: The requested module './export.cjs' does not provide an export named 'name'</span>


console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
<span class="token comment">// { name: 'xxx' }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>还有一种方法可以加载 CommonJS 模块。就是使用 ES6 模块的 <code>import()</code> 方法。但是看打印的值， 发现它会自动将模块内容挂载在 <code>default</code> 上。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import.js</span>

<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./export.cjs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
  <span class="token comment">// { default: { name: 'xxx' } }</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参考资料：</p> <p><a href="https://es6.ruanyifeng.com/#docs/module" target="_blank" rel="noopener noreferrer">阮一峰的es6教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">10/14/2022, 4:05:31 PM</span></div></footer> <!----> </main></div><div class="global-ui"><div class="footer-box" style="padding-left:20rem;" data-v-497fb04d><div class="footer-left" data-v-497fb04d><h2 class="footer-title" data-v-497fb04d><span class="logo-icon" data-v-497fb04d><img src="/vuepress-blog-lxh/assets/img/logo.664df77c.svg" data-v-497fb04d></span>
      江湖录 | <span class="small-tip" data-v-497fb04d>孤独的人的江湖路</span></h2> <p data-v-497fb04d>本站点所有图片图标资源尽皆都是百度来的， 如有侵权，立删！</p> <p data-v-497fb04d>联系email: lxhaweb@163.com</p></div> <div class="footer-right" data-v-497fb04d></div></div><!----></div></div>
    <script src="/vuepress-blog-lxh/assets/js/app.8d32188a.js" defer></script><script src="/vuepress-blog-lxh/assets/js/2.ae6c3983.js" defer></script><script src="/vuepress-blog-lxh/assets/js/20.f70dd27d.js" defer></script><script src="/vuepress-blog-lxh/assets/js/6.b516d596.js" defer></script>
  </body>
</html>
